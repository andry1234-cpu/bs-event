<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactions Overlay - Bending Spoons Event</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1920px;
            height: 1080px;
            overflow: hidden;
            background: transparent;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            position: relative;
        }

        .reactions-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .reaction {
            position: absolute;
            font-size: 80px;
            animation: float-up 4s ease-out forwards;
            opacity: 0;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            will-change: transform, opacity;
        }

        @keyframes float-up {
            0% {
                transform: translateY(0) scale(0.5) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translateY(-50px) scale(1) rotate(5deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-400px) scale(1.1) rotate(-5deg);
            }
            100% {
                transform: translateY(-1080px) scale(0.8) rotate(10deg);
                opacity: 0;
            }
        }

        /* Varianti di animazione per più varietà */
        .reaction.variant-1 {
            animation: float-up-left 4s ease-out forwards;
        }

        .reaction.variant-2 {
            animation: float-up-right 4s ease-out forwards;
        }

        @keyframes float-up-left {
            0% {
                transform: translateY(0) translateX(0) scale(0.5) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translateY(-50px) translateX(-30px) scale(1) rotate(-5deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-400px) translateX(-80px) scale(1.1) rotate(10deg);
            }
            100% {
                transform: translateY(-1080px) translateX(-120px) scale(0.8) rotate(-15deg);
                opacity: 0;
            }
        }

        @keyframes float-up-right {
            0% {
                transform: translateY(0) translateX(0) scale(0.5) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translateY(-50px) translateX(30px) scale(1) rotate(5deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-400px) translateX(80px) scale(1.1) rotate(-10deg);
            }
            100% {
                transform: translateY(-1080px) translateX(120px) scale(0.8) rotate(15deg);
                opacity: 0;
            }
        }

        /* Status indicator */
        .status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #10B981;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .status.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.4;
            }
        }

        .status.error {
            color: #EF4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status.error .status-dot {
            background: #EF4444;
        }
    </style>
</head>
<body>
    <div class="status" id="status">
        <div class="status-dot"></div>
        <span id="status-text">Connessione in corso...</span>
    </div>

    <div class="reactions-container" id="reactions-container"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCmEbIjFLlLxVgLUqwsOLCsB0aoMWF6PJQ",
            authDomain: "bendingspoons-eventdec25.firebaseapp.com",
            databaseURL: "https://bendingspoons-eventdec25-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bendingspoons-eventdec25",
            storageBucket: "bendingspoons-eventdec25.firebasestorage.app",
            messagingSenderId: "26050473198",
            appId: "1:26050473198:web:52d2e5d2bb912eaa2ad7ff",
            measurementId: "G-6C7XXL2XSN"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        const statusEl = document.getElementById('status');
        const statusTextEl = document.getElementById('status-text');
        const reactionsContainer = document.getElementById('reactions-container');

        let processedReactions = new Set();
        let isAuthenticated = false;

        function updateStatus(text, isError = false) {
            statusTextEl.textContent = text;
            if (isError) {
                statusEl.classList.add('error');
                statusEl.classList.remove('hidden');
            } else {
                statusEl.classList.remove('error');
                // Nascondi lo status dopo 2 secondi quando connesso
                if (text.includes('Connesso')) {
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 2000);
                }
            }
        }

        function createReaction(emoji) {
            const reaction = document.createElement('div');
            reaction.className = 'reaction';
            
            // Varianti casuali di animazione
            const variant = Math.floor(Math.random() * 3);
            if (variant === 1) {
                reaction.classList.add('variant-1');
            } else if (variant === 2) {
                reaction.classList.add('variant-2');
            }
            
            // Check if it's a custom emoji (URL or base64)
            if (emoji.startsWith('http') || emoji.startsWith('data:')) {
                const img = document.createElement('img');
                img.src = emoji;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'contain';
                reaction.appendChild(img);
            } else {
                reaction.textContent = emoji;
            }
            
            // Posizione X casuale (evitando i bordi)
            const randomX = 100 + Math.random() * (1920 - 200);
            reaction.style.left = randomX + 'px';
            reaction.style.bottom = '0px';
            
            // Piccola variazione nella dimensione
            const scale = 0.8 + Math.random() * 0.4;
            if (emoji.startsWith('http') || emoji.startsWith('data:')) {
                reaction.querySelector('img').style.width = (80 * scale) + 'px';
                reaction.querySelector('img').style.height = (80 * scale) + 'px';
            } else {
                reaction.style.fontSize = (80 * scale) + 'px';
            }
            
            reactionsContainer.appendChild(reaction);
            
            // Rimuovi dopo l'animazione
            setTimeout(() => {
                reaction.remove();
            }, 4000);
        }

        function handleReaction(reactionData) {
            const { emoji, timestamp, randomId, sequence } = reactionData;
            
            // Crea l'ID unico per questa reaction (usa sequence se presente, altrimenti randomId, altrimenti solo timestamp)
            const uniqueId = sequence !== undefined ? sequence : (randomId || timestamp);
            const reactionId = `${emoji}-${timestamp}-${uniqueId}`;
            
            // Se abbiamo già processato questa reaction, ignora
            if (processedReactions.has(reactionId)) {
                return;
            }
            
            // Aggiungi al set delle processate
            processedReactions.add(reactionId);
            
            // Limita la dimensione del set per evitare memory leak
            if (processedReactions.size > 1000) {
                const firstItem = processedReactions.values().next().value;
                processedReactions.delete(firstItem);
            }
            
            // Crea la reaction
            createReaction(emoji);
        }

        // Setup authentication
        function setupReactionsListener() {
            const reactionsRef = ref(database, 'reactions');
            const reactionsQuery = query(reactionsRef, orderByChild('timestamp'), limitToLast(50));

            let isFirstLoad = true;

            onValue(reactionsQuery, (snapshot) => {
                if (!snapshot.exists()) {
                    updateStatus('In attesa di reactions...');
                    return;
                }

                updateStatus('Connesso - In ascolto reactions');

                const reactions = [];
                snapshot.forEach((child) => {
                    reactions.push({
                        id: child.key,
                        ...child.val()
                    });
                });

                // Ordina per timestamp
                reactions.sort((a, b) => a.timestamp - b.timestamp);

                if (isFirstLoad) {
                    // Al primo caricamento, segna tutte come processate senza mostrarle
                    reactions.forEach(reaction => {
                        const reactionId = `${reaction.emoji}-${reaction.timestamp}`;
                        processedReactions.add(reactionId);
                    });
                    isFirstLoad = false;
                } else {
                    // Dopo il primo caricamento, mostra solo le nuove
                    reactions.forEach(reaction => {
                        handleReaction(reaction);
                    });
                }
            }, (error) => {
                console.error('Errore Firebase:', error);
                updateStatus('Errore di connessione - Verifica autenticazione', true);
            });
        }

        // Monitor auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                isAuthenticated = true;
                updateStatus(`Autenticato come ${user.email}`);
                
                // Check domain
                const emailDomain = user.email.split('@')[1];
                const allowedDomains = ['bendingspoons.com', 'dedgroup.com', 'urlo.events'];
                
                if (!allowedDomains.includes(emailDomain)) {
                    updateStatus(`Dominio non autorizzato: @${emailDomain}`, true);
                    await auth.signOut();
                    return;
                }
                
                // Start listening to reactions
                setupReactionsListener();
            } else {
                isAuthenticated = false;
                updateStatus('⚠️ Click per autenticarsi', true);
                
                // Add click listener for authentication
                statusEl.style.cursor = 'pointer';
                statusEl.onclick = async () => {
                    try {
                        updateStatus('Autenticazione in corso...');
                        await signInWithPopup(auth, googleProvider);
                    } catch (error) {
                        console.error('Login error:', error);
                        if (error.code !== 'auth/cancelled-popup-request' && error.code !== 'auth/popup-closed-by-user') {
                            updateStatus('Errore login: ' + error.message, true);
                        }
                    }
                };
            }
        });

        console.log('Overlay reactions inizializzato - 1920x1080');
    </script>
</body>
</html>
